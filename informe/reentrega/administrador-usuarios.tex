\subsection{Administrador de Usuarios.}

\begin{figure}[H]
   \centering
   \includegraphics[width=\textwidth]{reentrega/imagenes/usuarios.png}
   \caption{Administrador de Usuarios.}
\end{figure}

En este componente, se reciben y manejan muchos tipos de pedidos, todos enfocados en el usuario. Los pedidos nos pueden llegar de dos fuentes distintas, del \texttt{Administrador de desafios}, que nos manda pedidos de ver los equipos de un usuario, de crear un equipo nuevo, de ver la cantidad de fichas, de descontarle fichas o de sumarle fichas a un usuario. El resto de los pedidos, nos llegan del \texttt{Receptor de pedidos} que nos manda pedidos de login, registro, agregar medio de pago, eliminar medio de pago, mostrar medios de pagos ya registrados, comprar fichas, vender o retirar fichas, ver cantidad de fichas, ver equipos, crear equipos, entre otros.

Todos estos pedidos son recibidos por el \texttt{Manejador de pedidos}, que los comprende y actuando como un switch, fowardea el pedido al componente correspondiente.

Por otro lado tenemos un componente \texttt{Encriptador}, el cual se encarga de dada cierta información que le pasan, encriptarla o desencriptarla mediante un algoritmo asimetrico, utilizando la clave publica y la clave privada del Sistema. Asi de esta forma podemos encriptar información sensible, para luego persistirla ya encriptada y que unicamente pueda ser desencriptada con la clave privada del Sistema. Ademas contamos con el componete \texttt{Transmisor de datos}, que representa un simple pasamanos con el \texttt{Administrador de Datos}.

Entonces como dijimos, a este componente le pueden llegar una amplia variedad de pedidos, a continuacion detallaremos como es el flujo de atencion de cada uno de estos pedidos:

En el caso de un pedido de login, se le fowardea el pedido con el usuario y contraseña al \texttt{Autenticador de usuarios}. Este le pide al \texttt{Encriptador}, que nos encripte la contraseña y luego le pide al \texttt{Transmisor de datos} la contraseña que tenemos persistida en el sistema (la cual ya esta encriptada), entonces comparamos ambas contraseñas encriptadas y si estas son iguales, el usuario se autentico con exito, por lo que se le devuelve un codigo de autenticacion exitosa, en caso de ser distintas, se devuelve un codigo de autenticacion rechaza. Esta respuesta es para el \texttt{Manejador de pedidos}, que se encargara de propagar la respuesta a quien corresponda.

En el caso de un pedido de registro, le fowardeamos el pedido al \texttt{Registrador de usuario}, que le pide al \texttt{Encriptador} que le encripte la contraseña que nos llega y luego se encarga de persistir en el \texttt{Transmisor de Datos}, el nuevo usuario. En caso de que surga algun error en el proceso se devolvera un codigo de Registro Rechazado y sino un codigo de Registro Ok.

A al hora de recibir un pedido de agregar o registrar un nuevo medio de pago, se le fowardea el pedido al \texttt{Administrador de medios de pago}, que lo primero que realiza es comprobar que el medio de pago que se desea agregar se corresponde con el pais el cual esta registrado el usuario, para lo cual le consulta esta información al \texttt{Administrador de informacion basica del usuario}. En caso de que no se corresponda con el pais donde se registro el usuario, se rechaza la operacion. Luego una vez validado esto, se comunica con el Proveedor correspondiente y le pasamos la información que nos brindo el usuario. De esta forma el proveedor nos validara que es correcta la información que tenemos y ademas nos provee un token de identificacion para este medio de pago. En caso de fallar esta validación por parte del \texttt{Proveedor de medios de pagos}, se le rechaza la operacion. Una vez obtenido este token, lo tomamos junto a cierta información minima que nos permite reconocer el medio de pago (por ejemplo los ultimos 4 numeros de la tarjeta y el nombre del proveedor) y encriptamos esta informacion con ayuda del \texttt{Encriptador}. Luego una vez encriptada esta información, le pedimos al \texttt{Transmisor de datos} que persista este nuevo medio de pago. Una vez finilazado esto con exito, se devuelve Ok.

De la misma forma, un usuario puede querer eliminar un medio de pago que registro con anterioridad. En este caso, el usuario primero consultara ver los medios de pagos que ya tiene registrado. Esto dispara un pedido de mostrar los medios de pagos, que le llega al \texttt{Administrador de medios de pagos}, que a su vez se lo enviara al \texttt{Transmisor de Datos}. Este le obtendra el listado de la información basica de cada medio de pago que tiene asociado este usuario y se le propagara el listado hasta llegarle el usuario. Luego el usuario seleccionara que desea eleiminar uno de esos medios de pago . Esto se refleja en otro pedido que nos llega, de eliminar un medio de pago, con la información pertienente al medio de pago solicitado. Entonces el \texttt{Administrador de medios de pago} unicamente debe fowardear el pedido al \texttt{Transmisor de datos} de eliminar el medio de pago seleccionado.

Una vez que el cliente tiene registrado un medio de pago, este puede comprar y retirar/vender fichas. En el caso de que desee comprar fichas, nos llega un pedido con una cantidad de fichas que desea comprar. Este pedido le llega al \texttt{Administrador de fichas}, el cual le pide al \texttt{Administrador de medios de pago} el listado de todos los medios de pagos que tiene asociado el cliente, asi le da a elegir al cliente cual medio de pago desea utilizar. Una vez el cliente selecciono uno. Desde el \texttt{Administrador de fichas} le pedimos al \texttt{Administrador de medios de pagos} que le cobre al medio de pago correspondiente la plata asociada a la cantidad de fichas que el usuario pidio. Este último interactura con el \texttt{Proveedor de medios de pagos} correspondiente, utilizando el token que tenemos persistido en nuestro sistema. Si el \texttt{Proveedor de medio de pagos} nos rechaza la operación, entonces le rechazamos la operación al usuario. En cambio, si la operacion es aprobada el \texttt{Administrador de fichas}, le pide al \texttt{Transmisor de datos} que le agregue la nueva cantidad de fichas disponibles al usuario y se le responde que la operación fue exitosa.

Se da un caso similar, si el cliente quiere retirar o vender sus fichas. Primero nos llega un pedido de retirar una determinada cantidad de fichas al \texttt{Administrador de fichas}, igual que el caso anterior se le da a elegir al usuario que medio de pago quiere utilizar para recibir el dinero. Una vez que este lo eligio, le pedimos al \texttt{Administrador de medios de pagos}, que le deposite la plata correspondiente en ese medio de pago comunicandose con el \texttt{Proveedor de Medios de Pagos}. Si el proveedor nos rechaza la operación, entonces le rechazamos la operacion al usuario, en el caso contrario le pedimos al \texttt{Transmisor de datos} que le descuente la cantidad de fichas correspondientes al usuario.

Surgen dos casos muy parecidos a los de comprar y vender fichas, que son los pedidos que nos llegan del \texttt{Administrador de desafios}, que serian descontar fichas y agregar fichas. Estos simplificaciones de los anteriores, ya que unicamente el \texttt{Administrador de fichas} habla con el \texttt{Transmisor de datos} para restar o agregar fichas al usuario, ya que al tratarse del cobro de inscripción en desafios o el pago de premios de desafios, no necesitamos interactuar con ningun medio de pago.

Por otro lado llegan los pedidos de creación de equipos, que puede llegar tanto por el \texttt{Receptor de pedidos} o desde el \texttt{Administrador de desafios}. Este pedido entonces es fowardeado al \texttt{Administrador de equipos} que primero obtiene la información de los jugadores disponibles (en el caso de venir de un desafio tendra un scope de jugadores que permite el desafio) atravez del \texttt{Transmisor de datos}, para asi mostrarle al usuario los jugadores que puede elegir. Una vez que este selecciona los jugadores que quiere que integren su equipo. Nos llega un nuevo pedido, con estos por parametro y el \texttt{Administrador de equipos} le pide al \texttt{Transmisor de datos} que persista este nuevo equipo relacionado al usuario.

Ademas tenemos todos los pedidos que son únicamente de visualizar recursos, por ejemplo, ver cantidad de fichas, ver equipos ya creados, ver medios de pagos ya registrados o ver información basica del usuario (tipo perfil). Todos estos se fowardean a su componete correspondiente, es decir, si el pedido es de información basica al \texttt{Administrador de información basica}, si es de fichas al \texttt{Administrador de fichas}, etc. Entonces este componete se encargara de pasarle el pedido al \texttt{Transmisor de datos} para que nos obtenga los recursos solicitados y luego se le devuelven al usuario.
